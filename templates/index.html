<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Stock Rating Checker</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="position: absolute; top: 20px; right: 20px; z-index: 10;">
                <form action="https://www.paypal.com/donate" method="post" target="_blank" style="display: inline-block;">
                    <input type="hidden" name="hosted_button_id" value="5NZMFCF3GK3CQ" />
                    <button type="submit" title="Support this project via PayPal"
                            style="background: #FFC439; color: #2C2E2F; border: none; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 196, 57, 0.3); transition: all 0.3s ease;"
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(255, 196, 57, 0.4)';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 196, 57, 0.3)';">
                        Buy me Coffee â˜•
                    </button>
                </form>
            </div>
            <h1>ðŸ“ˆ Stock Ratings Comparator</h1>
            <p>Compare real-time ratings from Zacks, TipRanks, Barchart, Stockopedia and Analysts Forecast</p>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="tickerInput" placeholder="Enter ticker symbol (e.g., AAPL)" maxlength="10">
                <button id="searchBtn" onclick="searchRatings()">Get Ratings</button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">Fetching ratings and price data...</p>
                <p style="margin-top: 5px; color: #999; font-size: 0.8rem;">Optimized parallel execution ~3-4 seconds!</p>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="ticker-header">
                <div class="ticker-symbol" id="tickerSymbol"></div>
                <div class="price-display" id="priceDisplay" style="display: none;">
                    <div class="current-price" id="currentPrice">-</div>
                    <div class="price-change" id="priceChange">-</div>
                </div>
                <div class="price-target-display" id="priceTargetDisplay" style="display: none;">
                    <div class="target-label">Analyst Target:</div>
                    <div class="target-price" id="targetPrice">-</div>
                    <div class="price-difference" id="priceDifference">-</div>
                </div>
                <div class="timestamp" id="timestamp"></div>
            </div>

            <div class="ratings-grid" id="ratingsGrid">
                <!-- Zacks Card -->
                <a href="#" id="zacksCardLink" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                    <div class="rating-card" style="cursor: pointer; transition: all 0.3s ease;">
                        <div class="platform-header">
                            <div class="platform-info">
                                <div class="platform-logo zacks-logo">Z</div>
                                <div class="platform-name">Zacks</div>
                            </div>
                        </div>
                        <div class="rating-display">
                            <div class="rating-value" id="zacksRating">-</div>
                            <div class="rating-score" id="zacksRank">Rank: -</div>
                            <div class="rating-description" id="zacksStatus">-</div>
                        </div>
                    </div>
                </a>

                <!-- TipRanks Card -->
                <a href="#" id="tipranksCardLink" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                    <div class="rating-card" style="cursor: pointer; transition: all 0.3s ease;">
                        <div class="platform-header">
                            <div class="platform-info">
                                <div class="platform-logo tipranks-logo">T</div>
                                <div class="platform-name">TipRanks</div>
                            </div>
                        </div>
                        <div class="rating-display">
                            <div class="rating-value" id="tipranksRating">-</div>
                            <div class="rating-score" id="tipranksScore">Smart Score: -/10</div>
                            <div class="rating-description" id="tipranksStatus">-</div>
                        </div>
                    </div>
                </a>

                <!-- Barchart Card -->
                <a href="#" id="barchartCardLink" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                    <div class="rating-card" style="cursor: pointer; transition: all 0.3s ease;">
                        <div class="platform-header">
                            <div class="platform-info">
                                <div class="platform-logo barchart-logo">B</div>
                                <div class="platform-name">Barchart</div>
                            </div>
                        </div>
                        <div class="rating-display">
                            <div class="rating-value" id="barchartRating">-</div>
                            <div class="rating-score" id="barchartScore">Score: -</div>
                            <div class="rating-description" id="barchartStatus">-</div>
                        </div>
                    </div>
                </a>

                <!-- Stockopedia Card -->
                <a href="#" id="stockopediaCardLink" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                    <div class="rating-card" style="cursor: pointer; transition: all 0.3s ease;">
                        <div class="platform-header">
                            <div class="platform-info">
                                <div class="platform-logo stockopedia-logo">S</div>
                                <div class="platform-name">Stockopedia</div>
                            </div>
                        </div>
                        <div class="rating-display">
                            <div class="rating-value" id="stockopediaRating">-</div>
                            <div class="rating-score" id="stockopediaScore">StockRank: -/100</div>
                            <div class="rating-description" id="stockopediaStatus">-</div>
                        </div>
                    </div>
                </a>

                <!-- Stock Analysis Card -->
                <a href="#" id="stockanalysisCardLink" target="_blank" rel="noopener noreferrer" style="text-decoration: none; color: inherit;">
                    <div class="rating-card" style="cursor: pointer; transition: all 0.3s ease;">
                        <div class="platform-header">
                            <div class="platform-info">
                                <div class="platform-logo stockanalysis-logo">SA</div>
                                <div class="platform-name">Analysts Forecast</div>
                            </div>
                        </div>
                        <div class="rating-display">
                            <div class="rating-value" id="stockanalysisRating">-</div>
                            <div class="rating-score" id="stockanalysisAnalysts">Analysts: -</div>
                            <div class="rating-description" id="stockanalysisStatus">-</div>
                        </div>
                    </div>
                </a>
            </div>

            <div class="consensus-section">
                <div class="consensus-title">ðŸ“Š Consensus Analysis</div>
                <div class="consensus-result" id="consensusResult">-</div>
                <div class="rating-description" id="consensusDescription">-</div>
            </div>

            <div style="text-align: center; margin-top: 15px; padding: 10px;">
                <p style="color: #666; margin-bottom: 10px; font-size: 0.9rem;">Found this tool helpful? â˜•</p>
                <form action="https://www.paypal.com/donate" method="post" target="_blank" style="display: inline-block;">
                    <input type="hidden" name="hosted_button_id" value="5NZMFCF3GK3CQ" />
                    <button type="submit" title="Support this project via PayPal" 
                            style="background: #FFC439; color: #2C2E2F; border: none; padding: 8px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 196, 57, 0.3);">
                        Buy me Coffee â˜•
                    </button>
                </form>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <script>
        // Allow Enter key to trigger search
        document.getElementById('tickerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRatings();
            }
        });

        function searchRatings() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            
            if (!ticker) {
                showError('Please enter a ticker symbol');
                return;
            }

            // Show loading state
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').textContent = 'Fetching...';

            // Initialize results display immediately
            initializeResultsDisplay(ticker);

            // Use single parallel request (fastest approach)
            fetch('/get_ratings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ticker: ticker })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    // Simulate progressive loading for better UX
                    displayResultsProgressively(data);
                }
            })
            .catch(error => {
                showError('Network error: ' + error.message);
            })
            .finally(() => {
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').textContent = 'Get Ratings';
            });
        }

        function displayResultsProgressively(data) {
            // Update ticker with stock name and ticker symbol
            updateTickerDisplay(data.ticker, data.price ? data.price.stock_name : null);
            document.getElementById('timestamp').textContent = 'Updated: ' + data.timestamp;
            
            // Update all platform data immediately (no artificial delays)
            updatePriceDisplay(data.price);
            updatePlatformCard('zacks', data.zacks);
            updatePlatformCard('tipranks', data.tipranks);
            updatePlatformCard('barchart', data.barchart);
            updatePlatformCard('stockopedia', data.stockopedia);
            updatePlatformCard('stockanalysis', data.stockanalysis);
            
            // Update price target display after price is available
            updatePriceTargetDisplay(data.stockanalysis);
            
            // Display consensus immediately
            displayConsensus(data);
            
            // Hide loading indicator
            document.getElementById('loading').style.display = 'none';
        }

        function updatePlatformCard(platform, data) {
            switch(platform) {
                case 'zacks':
                    updateRatingCard('zacks', data, data.rank ? `Rank: ${data.rank}` : '');
                    break;
                case 'tipranks':
                    updateRatingCard('tipranks', data, data.score ? `Smart Score: ${data.score}/10` : '');
                    break;
                case 'barchart':
                    updateRatingCard('barchart', data, data.score ? `Score: ${data.score}` : '');
                    break;
                case 'stockopedia':
                    updateStockopediaCard('stockopedia', data);
                    break;
                case 'stockanalysis':
                    updateStockAnalysisCard('stockanalysis', data);
                    break;
            }
        }

        function initializeResultsDisplay(ticker) {
            // Show results section early with loading indicators
            document.getElementById('tickerSymbol').textContent = ticker;
            document.getElementById('timestamp').textContent = 'Loading...';
            updatePlatformLinks(ticker);
            
            // Show price loading state (simplified)
            const priceDisplay = document.getElementById('priceDisplay');
            const currentPrice = document.getElementById('currentPrice');
            const priceChange = document.getElementById('priceChange');
            currentPrice.textContent = 'â³';
            priceChange.textContent = '';
            priceChange.className = 'price-change';
            priceDisplay.style.display = 'inline-block';
            
            // Show price target loading state
            const priceTargetDisplay = document.getElementById('priceTargetDisplay');
            const targetPrice = document.getElementById('targetPrice');
            const priceDifference = document.getElementById('priceDifference');
            targetPrice.textContent = 'â³';
            priceDifference.textContent = '...';
            priceDifference.className = 'price-difference';
            priceTargetDisplay.style.display = 'inline-block';
            
            // Show all cards with loading state
            const platforms = ['zacks', 'tipranks', 'barchart', 'stockopedia', 'stockanalysis'];
            platforms.forEach(platform => {
                const ratingElement = document.getElementById(platform + 'Rating');
                const statusElement = document.getElementById(platform + 'Status');
                const scoreElement = document.getElementById(platform + 'Score');
                
                ratingElement.textContent = 'â³';
                ratingElement.className = 'rating-value';
                statusElement.textContent = '...';
                statusElement.className = 'rating-description status-warning';
                
                // Initialize score elements if they exist
                if (scoreElement) {
                    scoreElement.textContent = '...';
                }
            });
            
            // Show results section and hide main loading
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function displayResults(data) {
            // Update ticker and timestamp
            document.getElementById('tickerSymbol').textContent = data.ticker;
            document.getElementById('timestamp').textContent = 'Updated: ' + data.timestamp;

            // Update platform links
            updatePlatformLinks(data.ticker);

            // Update Zacks
            updateRatingCard('zacks', data.zacks, data.zacks.rank ? `Rank: ${data.zacks.rank}` : '');

            // Update TipRanks
            updateRatingCard('tipranks', data.tipranks, data.tipranks.score ? `Smart Score: ${data.tipranks.score}/10` : '');

            // Update Barchart
            updateRatingCard('barchart', data.barchart, 'Opinion');

            // Update Stockopedia
            updateStockopediaCard('stockopedia', data.stockopedia);

            // Calculate and display consensus
            displayConsensus(data);

            // Show results
            document.getElementById('resultsSection').style.display = 'block';
        }

        function updatePlatformLinks(ticker) {
            const tickerUpper = ticker.toUpperCase();
            const tickerLower = ticker.toLowerCase();
            
            // Update Zacks links (both card and platform name)
            const zacksUrl = `https://www.zacks.com/stock/quote/${tickerUpper}`;
            document.getElementById('zacksCardLink').href = zacksUrl;
            
            // Update TipRanks links
            const tipranksUrl = `https://www.tipranks.com/stocks/${tickerLower}`;
            document.getElementById('tipranksCardLink').href = tipranksUrl;
            
            // Update Barchart links
            const barchartUrl = `https://www.barchart.com/stocks/quotes/${tickerLower}/overview`;
            document.getElementById('barchartCardLink').href = barchartUrl;
            
            // Update Stockopedia links
            const stockopediaUrl = `https://www.stockopedia.com/share-prices/${tickerLower}-NSQ:${tickerUpper}/`;
            document.getElementById('stockopediaCardLink').href = stockopediaUrl;
            
            // Update Stock Analysis links
            const stockanalysisUrl = `https://stockanalysis.com/stocks/${tickerLower}/forecast/`;
            document.getElementById('stockanalysisCardLink').href = stockanalysisUrl;
        }

        function updateRatingCard(platform, data, scoreText) {
            const ratingElement = document.getElementById(platform + 'Rating');
            const scoreElement = document.getElementById(platform + 'Score') || document.getElementById(platform + 'Rank');
            const statusElement = document.getElementById(platform + 'Status');

            const rating = data.rating || data.rating || 'N/A';
            
            ratingElement.textContent = rating;
            if (scoreElement) scoreElement.textContent = scoreText;
            
            // Hide status description for these platforms (keep only for stockanalysis)
            statusElement.style.display = 'none';

            // Remove existing rating classes
            ratingElement.className = 'rating-value';
            
            // Add appropriate class based on rating
            const normalizedRating = rating.toLowerCase().replace(/\s+/g, '-');
            ratingElement.classList.add('rating-' + normalizedRating);
        }

        function updateStockopediaCard(platform, data) {
            const ratingElement = document.getElementById(platform + 'Rating');
            const scoreElement = document.getElementById(platform + 'Score');
            const statusElement = document.getElementById(platform + 'Status');

            const stockrank = data.stockrank || 'N/A';
            const category = data.category || 'Unknown';
            
            ratingElement.textContent = category;
            if (scoreElement) scoreElement.textContent = `StockRank: ${stockrank}/100`;
            
            // Hide status description for Stockopedia
            statusElement.style.display = 'none';

            // Remove existing rating classes
            ratingElement.className = 'rating-value';
            
            // Add appropriate class based on category
            const normalizedCategory = category.toLowerCase().replace(/\s+/g, '-');
            ratingElement.classList.add('rating-' + normalizedCategory);
        }


        function updateStockAnalysisCard(platform, data) {
            const ratingElement = document.getElementById(platform + 'Rating');
            const analystsElement = document.getElementById(platform + 'Analysts');
            const statusElement = document.getElementById(platform + 'Status');

            const consensus = data.consensus || 'N/A';
            const analysts = data.analyst_count || 'N/A';
            const priceTarget = data.price_target || 'N/A';
            
            ratingElement.textContent = consensus;
            analystsElement.textContent = `Analysts: ${analysts}`;
            statusElement.textContent = priceTarget !== 'N/A' ? `Target: $${priceTarget}` : 'No target';

            // Remove existing rating classes
            ratingElement.className = 'rating-value';
            
            // Add appropriate class based on consensus
            const normalizedConsensus = consensus.toLowerCase().replace(/\s+/g, '-');
            ratingElement.classList.add('rating-' + normalizedConsensus);

            // Set status color
            statusElement.className = 'rating-description';
            if (data.success) {
                statusElement.classList.add('status-success');
            } else {
                statusElement.classList.add('status-error');
            }
        }

        function updateTickerDisplay(ticker, stockName) {
            const tickerElement = document.getElementById('tickerSymbol');
            
            if (stockName && stockName !== ticker) {
                // Display stock name with ticker in brackets
                tickerElement.textContent = `${stockName} (${ticker})`;
            } else {
                // Fallback to just ticker if no stock name available
                tickerElement.textContent = ticker;
            }
        }

        function updatePriceDisplay(priceData) {
            const priceDisplay = document.getElementById('priceDisplay');
            const currentPrice = document.getElementById('currentPrice');
            const priceChange = document.getElementById('priceChange');

            if (priceData && priceData.success && priceData.current_price !== 'N/A') {
                const price = priceData.current_price;
                const change = priceData.change;
                const changePercent = priceData.change_percent;
                const currency = priceData.currency || 'USD';

                // Update current price
                currentPrice.textContent = `$${price} ${currency}`;

                // Update change with appropriate color and sign
                const changeText = `${change >= 0 ? '+' : ''}${change} (${changePercent >= 0 ? '+' : ''}${changePercent}%)`;
                priceChange.textContent = changeText;
                
                // Apply color based on positive/negative
                priceChange.className = 'price-change ' + (change >= 0 ? 'price-positive' : 'price-negative');

                // Show the price display
                priceDisplay.style.display = 'inline-block';
            } else {
                // Hide price display if no data
                priceDisplay.style.display = 'none';
            }
        }

        function updatePriceTargetDisplay(stockAnalysisData) {
            const priceTargetDisplay = document.getElementById('priceTargetDisplay');
            const targetPrice = document.getElementById('targetPrice');
            const priceDifference = document.getElementById('priceDifference');

            if (stockAnalysisData && stockAnalysisData.success && stockAnalysisData.price_target && stockAnalysisData.price_target !== 'N/A') {
                const target = parseFloat(stockAnalysisData.price_target);
                
                // Update target price
                targetPrice.textContent = `$${target.toFixed(2)}`;

                // Calculate price difference if current price is available
                const currentPriceElement = document.getElementById('currentPrice');
                const currentPriceText = currentPriceElement.textContent;
                
                // Extract current price from text like "$377.04 USD"
                const priceMatch = currentPriceText.match(/\$([0-9,]+\.?[0-9]*)/);
                
                if (priceMatch) {
                    const currentPrice = parseFloat(priceMatch[1].replace(/,/g, ''));
                    const difference = target - currentPrice;
                    const percentDifference = ((difference / currentPrice) * 100);
                    
                    // Format the difference display
                    const sign = difference >= 0 ? '+' : '';
                    const diffText = `${sign}${difference.toFixed(2)} (${sign}${percentDifference.toFixed(2)}%)`;
                    
                    priceDifference.textContent = diffText;
                    
                    // Apply color based on positive/negative
                    priceDifference.className = 'price-difference ' + (difference >= 0 ? 'positive' : 'negative');
                } else {
                    // If current price not available, hide difference
                    priceDifference.textContent = 'Calculating...';
                    priceDifference.className = 'price-difference';
                }

                // Show the price target display
                priceTargetDisplay.style.display = 'inline-block';
            } else {
                // Hide price target display if no data
                priceTargetDisplay.style.display = 'none';
            }
        }

        function displayConsensus(data) {
            const consensusElement = document.getElementById('consensusResult');
            const descriptionElement = document.getElementById('consensusDescription');

            // Count positive and negative ratings
            let positive = 0;
            let negative = 0;
            let neutral = 0;
            let total = 0;

            // Analyze Zacks
            if (data.zacks.success) {
                total++;
                const zacksRating = data.zacks.rating.toLowerCase();
                if (zacksRating.includes('strong buy') || zacksRating.includes('buy')) positive++;
                else if (zacksRating.includes('sell')) negative++;
                else neutral++;
            }

            // Analyze TipRanks
            if (data.tipranks.success) {
                total++;
                const tipranksRating = data.tipranks.rating.toLowerCase();
                if (tipranksRating.includes('outperform')) positive++;
                else if (tipranksRating.includes('underperform')) negative++;
                else neutral++;
            }

            // Analyze Barchart
            if (data.barchart.success) {
                total++;
                const barchartRating = data.barchart.rating.toLowerCase();
                if (barchartRating.includes('strong buy') || barchartRating.includes('buy')) positive++;
                else if (barchartRating.includes('sell')) negative++;
                else neutral++;
            }

            // Analyze Stockopedia
            if (data.stockopedia.success) {
                total++;
                const stockopediaCategory = data.stockopedia.category.toLowerCase();
                if (stockopediaCategory.includes('excellent') || stockopediaCategory.includes('good')) positive++;
                else if (stockopediaCategory.includes('poor')) negative++;
                else neutral++;
            }

            // Analyze Stock Analysis
            if (data.stockanalysis.success) {
                total++;
                const stockanalysisConsensus = data.stockanalysis.consensus.toLowerCase();
                if (stockanalysisConsensus.includes('strong buy') || stockanalysisConsensus.includes('buy')) positive++;
                else if (stockanalysisConsensus.includes('sell')) negative++;
                else neutral++;
            }

            // Determine consensus
            let consensus = '';
            let description = '';
            let cssClass = '';

            const majority = Math.ceil(total / 2);

            if (positive >= majority) {
                consensus = 'ðŸ”¥ BUY CONSENSUS';
                description = `${positive} of ${total} platforms recommend buying`;
                cssClass = 'rating-strong-buy';
            } else if (negative >= majority) {
                consensus = 'âš ï¸ SELL CONSENSUS';
                description = `${negative} of ${total} platforms recommend selling`;
                cssClass = 'rating-strong-sell';
            } else if (neutral >= majority) {
                consensus = 'ðŸ“Š HOLD CONSENSUS';
                description = `${neutral} of ${total} platforms recommend holding`;
                cssClass = 'rating-hold';
            } else {
                consensus = 'ðŸ¤” MIXED SIGNALS';
                description = 'Platforms show conflicting recommendations';
                cssClass = 'rating-neutral';
            }

            consensusElement.textContent = consensus;
            consensusElement.className = 'consensus-result ' + cssClass;
            descriptionElement.textContent = description;
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        }
    </script>
</body>
</html>
