<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Stock Rating Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .donate-section {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .donate-button {
            transition: all 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .donate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .donate-button button {
            background: linear-gradient(135deg, #FFC439, #FFB800);
            color: #2C2E2F;
            border: none;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 196, 57, 0.3);
            border: 1px solid #E6A800;
        }

        .donate-button button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 196, 57, 0.4);
            background: linear-gradient(135deg, #FFD700, #FFC439);
        }

        .donate-button button:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(255, 196, 57, 0.2);
            background: linear-gradient(135deg, #FFB800, #E6A800);
        }

        .search-section {
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
        }

        .search-box {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        #tickerInput {
            padding: 15px 20px;
            font-size: 1.2rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 300px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        #tickerInput:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #searchBtn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        #searchBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        #searchBtn:active {
            transform: translateY(0);
            box-shadow: 0 5px 10px rgba(102, 126, 234, 0.2);
        }

        #searchBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .platform-link {
            cursor: pointer;
        }

        /* Mobile touch improvements */
        @media (hover: none) and (pointer: coarse) {
            #searchBtn:hover {
                transform: none;
                box-shadow: none;
            }
            
            #searchBtn:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            .rating-card:hover {
                transform: none;
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            }
            
            .platform-link:hover {
                background-color: transparent;
                transform: none;
            }

            .platform-link:hover .platform-name::after {
                opacity: 0.4;
            }
            
            .platform-link:active {
                background-color: rgba(102, 126, 234, 0.2);
                transform: scale(0.98);
            }

            .platform-name::after {
                opacity: 0.3;
            }
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .ticker-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .ticker-symbol {
            font-size: 3rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .price-display {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: inline-block;
        }

        .current-price {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .price-change {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .price-positive {
            color: #27ae60;
        }

        .price-negative {
            color: #e74c3c;
        }

        .timestamp {
            color: #666;
            font-size: 0.9rem;
        }

        .ratings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .rating-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 2px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .rating-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .rating-card.loading {
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .platform-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .platform-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: inherit;
            flex: 1;
            transition: all 0.2s ease;
            border-radius: 8px;
            padding: 4px;
            margin: -4px;
        }

        .platform-link:hover {
            background-color: rgba(102, 126, 234, 0.1);
            transform: translateX(3px);
            text-decoration: none;
            color: inherit;
        }

        .platform-link:visited {
            color: inherit;
        }

        .platform-link:active {
            transform: translateX(1px);
            background-color: rgba(102, 126, 234, 0.15);
        }

        .platform-info {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .platform-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .zacks-logo { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .tipranks-logo { background: linear-gradient(135deg, #3498db, #2980b9); }
        .barchart-logo { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .stockopedia-logo { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
        .stockanalysis-logo { background: linear-gradient(135deg, #e84c3d, #d63027); }

        .platform-name {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            position: relative;
        }

        .platform-name::after {
            content: "ðŸ”—";
            font-size: 0.8rem;
            opacity: 0;
            margin-left: 8px;
            transition: opacity 0.2s ease;
        }

        .platform-link:hover .platform-name::after {
            opacity: 0.6;
        }

        .rating-display {
            text-align: center;
        }

        .rating-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .rating-score {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 5px;
        }

        .rating-description {
            font-size: 1rem;
            color: #888;
        }

        .status-success { color: #27ae60; }
        .status-error { color: #e74c3c; }
        .status-warning { color: #f39c12; }

        .rating-strong-buy { color: #27ae60; background-color: #d5f4e6; }
        .rating-buy { color: #2ecc71; background-color: #e8f8f5; }
        .rating-hold { color: #f39c12; background-color: #fef9e7; }
        .rating-sell { color: #e67e22; background-color: #fdf2e9; }
        .rating-strong-sell { color: #e74c3c; background-color: #fadbd8; }
        .rating-outperform { color: #27ae60; background-color: #d5f4e6; }
        .rating-neutral { color: #f39c12; background-color: #fef9e7; }
        .rating-underperform { color: #e74c3c; background-color: #fadbd8; }
        .rating-excellent { color: #27ae60; background-color: #d5f4e6; }
        .rating-good { color: #2ecc71; background-color: #e8f8f5; }
        .rating-average { color: #f39c12; background-color: #fef9e7; }
        .rating-poor { color: #e67e22; background-color: #fdf2e9; }
        .rating-very-poor { color: #e74c3c; background-color: #fadbd8; }

        .consensus-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
        }

        .consensus-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .consensus-result {
            font-size: 1.8rem;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .error-message {
            background: #fadbd8;
            color: #e74c3c;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                border-radius: 10px;
                box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            }

            .header {
                padding: 20px 15px;
                padding-top: 60px;
            }

            .header h1 {
                font-size: 1.8rem;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 0.9rem;
            }

            .donate-section {
                position: absolute;
                top: 10px;
                right: 10px;
            }

            .donate-button button {
                font-size: 12px;
                padding: 6px 12px;
            }

            .search-section {
                padding: 25px 15px;
            }

            .search-box {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }

            #tickerInput {
                width: 100%;
                max-width: 280px;
                font-size: 1.1rem;
                padding: 12px 16px;
            }

            #searchBtn {
                width: 100%;
                max-width: 280px;
                font-size: 1.1rem;
                padding: 12px 24px;
            }

            .results-section {
                padding: 25px 15px;
            }

            .ticker-header {
                margin-bottom: 20px;
            }

            .ticker-symbol {
                font-size: 1.6rem;
                margin-bottom: 8px;
                line-height: 1.2;
                word-break: break-word;
            }

            .price-display {
                margin: 10px 0;
                padding: 12px;
                width: 100%;
                box-sizing: border-box;
            }

            .current-price {
                font-size: 1.5rem;
                margin-bottom: 3px;
            }

            .price-change {
                font-size: 1rem;
            }

            .ratings-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }

            .rating-card {
                padding: 18px;
                margin: 0;
            }

            .platform-header {
                margin-bottom: 15px;
            }

            .platform-logo {
                width: 32px;
                height: 32px;
                font-size: 1rem;
                margin-right: 12px;
            }

            .platform-name {
                font-size: 1.1rem;
            }

            .platform-name::after {
                font-size: 0.7rem;
                margin-left: 6px;
            }

            .rating-value {
                font-size: 1.8rem;
                padding: 12px;
                margin-bottom: 8px;
            }

            .rating-score {
                font-size: 1rem;
                margin-bottom: 3px;
            }

            .rating-description {
                font-size: 0.85rem;
            }

            .consensus-section {
                padding: 18px;
                margin-top: 20px;
                border-radius: 8px;
            }

            .consensus-title {
                font-size: 1.2rem;
                margin-bottom: 12px;
            }

            .consensus-result {
                font-size: 1.4rem;
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 6px;
                line-height: 1.3;
            }

            .error-message {
                margin: 15px 0;
                padding: 15px;
                font-size: 0.9rem;
            }

            .timestamp {
                font-size: 0.8rem;
                margin-top: 8px;
            }

            .loading {
                margin: 15px 0;
            }

            .spinner {
                width: 40px;
                height: 40px;
                border-width: 3px;
            }

            .loading p {
                font-size: 0.9rem !important;
                margin-top: 12px !important;
                padding: 0 10px;
            }

            .loading p:last-child {
                font-size: 0.75rem !important;
                margin-top: 3px !important;
                padding: 0 10px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 5px;
            }

            .header {
                padding: 15px 10px;
                padding-top: 55px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .donate-section {
                top: 8px;
                right: 8px;
            }

            .donate-button button {
                font-size: 11px;
                padding: 5px 10px;
            }

            .search-section {
                padding: 20px 10px;
            }

            .results-section {
                padding: 20px 10px;
            }

            .ticker-symbol {
                font-size: 1.4rem;
            }

            .current-price {
                font-size: 1.3rem;
            }

            .price-change {
                font-size: 0.9rem;
            }

            .rating-card {
                padding: 15px;
            }

            .platform-logo {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
                margin-right: 10px;
            }

            .platform-name {
                font-size: 1rem;
                line-height: 1.2;
            }

            .platform-name::after {
                font-size: 0.6rem;
                margin-left: 4px;
            }

            .rating-value {
                font-size: 1.6rem;
                padding: 10px;
            }

            .consensus-result {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="donate-section">
                <form action="https://www.paypal.com/donate" method="post" target="_blank" class="donate-button">
                    <input type="hidden" name="hosted_button_id" value="5NZMFCF3GK3CQ" />
                    <button type="submit" title="Support this project via PayPal">Buy me Coffee â˜•</button>
                    <img alt="" border="0" src="https://www.paypal.com/en_BE/i/scr/pixel.gif" width="1" height="1" />
                </form>
            </div>
            <h1>ðŸ“ˆ Stock Rating Checker</h1>
            <p>Get real-time ratings from Zacks, TipRanks, Barchart, Stockopedia, and Stock Analysis</p>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input type="text" id="tickerInput" placeholder="Enter ticker symbol (e.g., AAPL)" maxlength="10">
                <button id="searchBtn" onclick="searchRatings()">Get Ratings</button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 15px; color: #666;">Fetching ratings and price data...</p>
                <p style="margin-top: 5px; color: #999; font-size: 0.8rem;">Optimized parallel execution ~3-4 seconds!</p>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="ticker-header">
                <div class="ticker-symbol" id="tickerSymbol"></div>
                <div class="price-display" id="priceDisplay" style="display: none;">
                    <div class="current-price" id="currentPrice">-</div>
                    <div class="price-change" id="priceChange">-</div>
                </div>
                <div class="timestamp" id="timestamp"></div>
            </div>

            <div class="ratings-grid" id="ratingsGrid">
                <!-- Zacks Card -->
                <div class="rating-card">
                    <div class="platform-header">
                        <a href="#" class="platform-link" id="zacksLink" target="_blank" rel="noopener noreferrer">
                            <div class="platform-info">
                                <div class="platform-logo zacks-logo">Z</div>
                                <div class="platform-name">Zacks</div>
                            </div>
                        </a>
                    </div>
                    <div class="rating-display">
                        <div class="rating-value" id="zacksRating">-</div>
                        <div class="rating-score" id="zacksRank">Rank: -</div>
                        <div class="rating-description" id="zacksStatus">-</div>
                    </div>
                </div>

                <!-- TipRanks Card -->
                <div class="rating-card">
                    <div class="platform-header">
                        <a href="#" class="platform-link" id="tipranksLink" target="_blank" rel="noopener noreferrer">
                            <div class="platform-info">
                                <div class="platform-logo tipranks-logo">T</div>
                                <div class="platform-name">TipRanks</div>
                            </div>
                        </a>
                    </div>
                    <div class="rating-display">
                        <div class="rating-value" id="tipranksRating">-</div>
                        <div class="rating-score" id="tipranksScore">Smart Score: -/10</div>
                        <div class="rating-description" id="tipranksStatus">-</div>
                    </div>
                </div>

                <!-- Barchart Card -->
                                <!-- Barchart Card -->
                <div class="rating-card">
                    <div class="platform-header">
                        <a href="#" class="platform-link" id="barchartLink" target="_blank" rel="noopener noreferrer">
                            <div class="platform-info">
                                <div class="platform-logo barchart-logo">B</div>
                                <div class="platform-name">Barchart</div>
                            </div>
                        </a>
                    </div>
                    <div class="rating-display">
                        <div class="rating-value" id="barchartRating">-</div>
                        <div class="rating-description" id="barchartStatus">-</div>
                    </div>
                </div>

                <!-- Stockopedia Card -->
                <div class="rating-card">
                    <div class="platform-header">
                        <a href="#" class="platform-link" id="stockopediaLink" target="_blank" rel="noopener noreferrer">
                            <div class="platform-info">
                                <div class="platform-logo stockopedia-logo">S</div>
                                <div class="platform-name">Stockopedia</div>
                            </div>
                        </a>
                    </div>
                    <div class="rating-display">
                        <div class="rating-value" id="stockopediaRating">-</div>
                        <div class="rating-score" id="stockopediaScore">StockRank: -/100</div>
                        <div class="rating-description" id="stockopediaStatus">-</div>
                    </div>
                </div>

                <!-- Stock Analysis Card -->
                <div class="rating-card">
                    <div class="platform-header">
                        <a href="#" class="platform-link" id="stockanalysisLink" target="_blank" rel="noopener noreferrer">
                            <div class="platform-info">
                                <div class="platform-logo stockanalysis-logo">SA</div>
                                <div class="platform-name">Stock Analysis</div>
                            </div>
                        </a>
                    </div>
                    <div class="rating-display">
                        <div class="rating-value" id="stockanalysisRating">-</div>
                        <div class="rating-score" id="stockanalysisAnalysts">Analysts: -</div>
                        <div class="rating-description" id="stockanalysisStatus">-</div>
                    </div>
                </div>
            </div>

            <div class="consensus-section">
                <div class="consensus-title">ðŸ“Š Consensus Analysis</div>
                <div class="consensus-result" id="consensusResult">-</div>
                <div class="rating-description" id="consensusDescription">-</div>
            </div>

            <div class="bottom-donate-section" style="text-align: center; margin-top: 30px; padding: 0; background: none;">
                <p style="color: #666; margin-bottom: 15px; font-size: 0.9rem;">Found this tool helpful? â˜•</p>
                <form action="https://www.paypal.com/donate" method="post" target="_blank" class="donate-button" style="display: inline-block;">
                    <input type="hidden" name="hosted_button_id" value="5NZMFCF3GK3CQ" />
                    <button type="submit" title="Support this project via PayPal">Buy me Coffee â˜•</button>
                    <img alt="" border="0" src="https://www.paypal.com/en_BE/i/scr/pixel.gif" width="1" height="1" />
                </form>
            </div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
    </div>

    <script>
        // Allow Enter key to trigger search
        document.getElementById('tickerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchRatings();
            }
        });

        function searchRatings() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            
            if (!ticker) {
                showError('Please enter a ticker symbol');
                return;
            }

            // Show loading state
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').textContent = 'Fetching...';

            // Initialize results display immediately
            initializeResultsDisplay(ticker);

            // Use single parallel request (fastest approach)
            fetch('/get_ratings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ticker: ticker })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showError(data.error);
                } else {
                    // Simulate progressive loading for better UX
                    displayResultsProgressively(data);
                }
            })
            .catch(error => {
                showError('Network error: ' + error.message);
            })
            .finally(() => {
                document.getElementById('searchBtn').disabled = false;
                document.getElementById('searchBtn').textContent = 'Get Ratings';
            });
        }

        function displayResultsProgressively(data) {
            // Update ticker with stock name and ticker symbol
            updateTickerDisplay(data.ticker, data.price ? data.price.stock_name : null);
            document.getElementById('timestamp').textContent = 'Updated: ' + data.timestamp;
            
            // Update all platform data immediately (no artificial delays)
            updatePriceDisplay(data.price);
            updatePlatformCard('zacks', data.zacks);
            updatePlatformCard('tipranks', data.tipranks);
            updatePlatformCard('barchart', data.barchart);
            updatePlatformCard('stockopedia', data.stockopedia);
            updatePlatformCard('stockanalysis', data.stockanalysis);
            
            // Display consensus immediately
            displayConsensus(data);
            
            // Hide loading indicator
            document.getElementById('loading').style.display = 'none';
        }

        function updatePlatformCard(platform, data) {
            switch(platform) {
                case 'zacks':
                    updateRatingCard('zacks', data, data.rank ? `Rank: ${data.rank}` : '');
                    break;
                case 'tipranks':
                    updateRatingCard('tipranks', data, data.score ? `Smart Score: ${data.score}/10` : '');
                    break;
                case 'barchart':
                    updateRatingCard('barchart', data, 'Opinion');
                    break;
                case 'stockopedia':
                    updateStockopediaCard('stockopedia', data);
                    break;
                case 'stockanalysis':
                    updateStockAnalysisCard('stockanalysis', data);
                    break;
            }
        }

        function initializeResultsDisplay(ticker) {
            // Show results section early with loading indicators
            document.getElementById('tickerSymbol').textContent = ticker;
            document.getElementById('timestamp').textContent = 'Loading...';
            updatePlatformLinks(ticker);
            
            // Show price loading state (simplified)
            const priceDisplay = document.getElementById('priceDisplay');
            const currentPrice = document.getElementById('currentPrice');
            const priceChange = document.getElementById('priceChange');
            currentPrice.textContent = 'â³';
            priceChange.textContent = '';
            priceChange.className = 'price-change';
            priceDisplay.style.display = 'inline-block';
            
            // Show all cards with loading state
            const platforms = ['zacks', 'tipranks', 'barchart', 'stockopedia', 'stockanalysis'];
            platforms.forEach(platform => {
                const ratingElement = document.getElementById(platform + 'Rating');
                const statusElement = document.getElementById(platform + 'Status');
                
                ratingElement.textContent = 'â³';
                ratingElement.className = 'rating-value';
                statusElement.textContent = '...';
                statusElement.className = 'rating-description status-warning';
            });
            
            // Show results section and hide main loading
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        function displayResults(data) {
            // Update ticker and timestamp
            document.getElementById('tickerSymbol').textContent = data.ticker;
            document.getElementById('timestamp').textContent = 'Updated: ' + data.timestamp;

            // Update platform links
            updatePlatformLinks(data.ticker);

            // Update Zacks
            updateRatingCard('zacks', data.zacks, data.zacks.rank ? `Rank: ${data.zacks.rank}` : '');

            // Update TipRanks
            updateRatingCard('tipranks', data.tipranks, data.tipranks.score ? `Smart Score: ${data.tipranks.score}/10` : '');

            // Update Barchart
            updateRatingCard('barchart', data.barchart, 'Opinion');

            // Update Stockopedia
            updateStockopediaCard('stockopedia', data.stockopedia);

            // Calculate and display consensus
            displayConsensus(data);

            // Show results
            document.getElementById('resultsSection').style.display = 'block';
        }

        function updatePlatformLinks(ticker) {
            const tickerUpper = ticker.toUpperCase();
            const tickerLower = ticker.toLowerCase();
            
            // Update Zacks link
            document.getElementById('zacksLink').href = `https://www.zacks.com/stock/quote/${tickerUpper}`;
            
            // Update TipRanks link
            document.getElementById('tipranksLink').href = `https://www.tipranks.com/stocks/${tickerLower}`;
            
            // Update Barchart link
            document.getElementById('barchartLink').href = `https://www.barchart.com/stocks/quotes/${tickerLower}/overview`;
            
            // Update Stockopedia link
            document.getElementById('stockopediaLink').href = `https://www.stockopedia.com/share-prices/${tickerLower}-NSQ:${tickerUpper}/`;
        }

        function updateRatingCard(platform, data, scoreText) {
            const ratingElement = document.getElementById(platform + 'Rating');
            const scoreElement = document.getElementById(platform + 'Score') || document.getElementById(platform + 'Rank');
            const statusElement = document.getElementById(platform + 'Status');

            const rating = data.rating || data.rating || 'N/A';
            
            ratingElement.textContent = rating;
            if (scoreElement) scoreElement.textContent = scoreText;
            statusElement.textContent = data.status || 'Unknown';

            // Remove existing rating classes
            ratingElement.className = 'rating-value';
            
            // Add appropriate class based on rating
            const normalizedRating = rating.toLowerCase().replace(/\s+/g, '-');
            ratingElement.classList.add('rating-' + normalizedRating);

            // Set status color
            statusElement.className = 'rating-description';
            if (data.success) {
                statusElement.classList.add('status-success');
            } else {
                statusElement.classList.add('status-error');
            }
        }

        function updateStockopediaCard(platform, data) {
            const ratingElement = document.getElementById(platform + 'Rating');
            const scoreElement = document.getElementById(platform + 'Score');
            const statusElement = document.getElementById(platform + 'Status');

            const stockrank = data.stockrank || 'N/A';
            const category = data.category || 'Unknown';
            
            ratingElement.textContent = category;
            if (scoreElement) scoreElement.textContent = `StockRank: ${stockrank}/100`;
            statusElement.textContent = data.status || 'Unknown';

            // Remove existing rating classes
            ratingElement.className = 'rating-value';
            
            // Add appropriate class based on category
            const normalizedCategory = category.toLowerCase().replace(/\s+/g, '-');
            ratingElement.classList.add('rating-' + normalizedCategory);

            // Set status color
            statusElement.className = 'rating-description';
            if (data.success) {
                statusElement.classList.add('status-success');
            } else {
                statusElement.classList.add('status-error');
            }
        }


        function updateStockAnalysisCard(platform, data) {
            const ratingElement = document.getElementById(platform + 'Rating');
            const analystsElement = document.getElementById(platform + 'Analysts');
            const statusElement = document.getElementById(platform + 'Status');

            const consensus = data.consensus || 'N/A';
            const analysts = data.analyst_count || 'N/A';
            const priceTarget = data.price_target || 'N/A';
            
            ratingElement.textContent = consensus;
            analystsElement.textContent = `Analysts: ${analysts}`;
            statusElement.textContent = priceTarget !== 'N/A' ? `Target: $${priceTarget}` : 'No target';

            // Remove existing rating classes
            ratingElement.className = 'rating-value';
            
            // Add appropriate class based on consensus
            const normalizedConsensus = consensus.toLowerCase().replace(/\s+/g, '-');
            ratingElement.classList.add('rating-' + normalizedConsensus);

            // Set status color
            statusElement.className = 'rating-description';
            if (data.success) {
                statusElement.classList.add('status-success');
            } else {
                statusElement.classList.add('status-error');
            }

            // Update Stock Analysis link
            const ticker = document.getElementById('tickerSymbol').textContent;
            document.getElementById('stockanalysisLink').href = `https://stockanalysis.com/stocks/${ticker.toLowerCase()}/forecast/`;
        }

        function updateTickerDisplay(ticker, stockName) {
            const tickerElement = document.getElementById('tickerSymbol');
            
            if (stockName && stockName !== ticker) {
                // Display stock name with ticker in brackets
                tickerElement.textContent = `${stockName} (${ticker})`;
            } else {
                // Fallback to just ticker if no stock name available
                tickerElement.textContent = ticker;
            }
        }

        function updatePriceDisplay(priceData) {
            const priceDisplay = document.getElementById('priceDisplay');
            const currentPrice = document.getElementById('currentPrice');
            const priceChange = document.getElementById('priceChange');

            if (priceData && priceData.success && priceData.current_price !== 'N/A') {
                const price = priceData.current_price;
                const change = priceData.change;
                const changePercent = priceData.change_percent;
                const currency = priceData.currency || 'USD';

                // Update current price
                currentPrice.textContent = `$${price} ${currency}`;

                // Update change with appropriate color and sign
                const changeText = `${change >= 0 ? '+' : ''}${change} (${changePercent >= 0 ? '+' : ''}${changePercent}%)`;
                priceChange.textContent = changeText;
                
                // Apply color based on positive/negative
                priceChange.className = 'price-change ' + (change >= 0 ? 'price-positive' : 'price-negative');

                // Show the price display
                priceDisplay.style.display = 'inline-block';
            } else {
                // Hide price display if no data
                priceDisplay.style.display = 'none';
            }
        }

        function displayConsensus(data) {
            const consensusElement = document.getElementById('consensusResult');
            const descriptionElement = document.getElementById('consensusDescription');

            // Count positive and negative ratings
            let positive = 0;
            let negative = 0;
            let neutral = 0;
            let total = 0;

            // Analyze Zacks
            if (data.zacks.success) {
                total++;
                const zacksRating = data.zacks.rating.toLowerCase();
                if (zacksRating.includes('strong buy') || zacksRating.includes('buy')) positive++;
                else if (zacksRating.includes('sell')) negative++;
                else neutral++;
            }

            // Analyze TipRanks
            if (data.tipranks.success) {
                total++;
                const tipranksRating = data.tipranks.rating.toLowerCase();
                if (tipranksRating.includes('outperform')) positive++;
                else if (tipranksRating.includes('underperform')) negative++;
                else neutral++;
            }

            // Analyze Barchart
            if (data.barchart.success) {
                total++;
                const barchartRating = data.barchart.rating.toLowerCase();
                if (barchartRating.includes('strong buy') || barchartRating.includes('buy')) positive++;
                else if (barchartRating.includes('sell')) negative++;
                else neutral++;
            }

            // Analyze Stockopedia
            if (data.stockopedia.success) {
                total++;
                const stockopediaCategory = data.stockopedia.category.toLowerCase();
                if (stockopediaCategory.includes('excellent') || stockopediaCategory.includes('good')) positive++;
                else if (stockopediaCategory.includes('poor')) negative++;
                else neutral++;
            }

            // Analyze Stock Analysis
            if (data.stockanalysis.success) {
                total++;
                const stockanalysisConsensus = data.stockanalysis.consensus.toLowerCase();
                if (stockanalysisConsensus.includes('strong buy') || stockanalysisConsensus.includes('buy')) positive++;
                else if (stockanalysisConsensus.includes('sell')) negative++;
                else neutral++;
            }

            // Determine consensus
            let consensus = '';
            let description = '';
            let cssClass = '';

            const majority = Math.ceil(total / 2);

            if (positive >= majority) {
                consensus = 'ðŸ”¥ BUY CONSENSUS';
                description = `${positive} of ${total} platforms recommend buying`;
                cssClass = 'rating-strong-buy';
            } else if (negative >= majority) {
                consensus = 'âš ï¸ SELL CONSENSUS';
                description = `${negative} of ${total} platforms recommend selling`;
                cssClass = 'rating-strong-sell';
            } else if (neutral >= majority) {
                consensus = 'ðŸ“Š HOLD CONSENSUS';
                description = `${neutral} of ${total} platforms recommend holding`;
                cssClass = 'rating-hold';
            } else {
                consensus = 'ðŸ¤” MIXED SIGNALS';
                description = 'Platforms show conflicting recommendations';
                cssClass = 'rating-neutral';
            }

            consensusElement.textContent = consensus;
            consensusElement.className = 'consensus-result ' + cssClass;
            descriptionElement.textContent = description;
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
        }
    </script>
</body>
</html>
